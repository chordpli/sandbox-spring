# 데이터 적재 멱등성 전략별 성능 테스트 최종 결과

## 1. 테스트 개요

- **목표:** 다양한 멱등성 보장 전략에 따른 데이터 적재 성능을 비교 분석한다.
- **데이터셋:** 초기 데이터(A) 100,000건, 추가 데이터(B) 100,000건 (90% 중복)
- **환경:** Apple M2 Pro, 16GB Memory, PostgreSQL

## 2. 최종 테스트 결과 (20만건 기준)

| 시나리오                                             | 평균 실행 시간 (ms) | 초당 처리량 (RPS) | 상태     |
| ---------------------------------------------------- | ------------------- | ----------------- | -------- |
| **1-1:** App-level SELECT 후 INSERT (인덱스 없음)      | 3,126,000           | ~32               | **완료** |
| **1-2:** App-level SELECT 후 INSERT (인덱스 있음)      | 293,000             | ~341              | **완료** |
| **2-1:** `ON CONFLICT` (복합 유니크 키)                | 28,333              | ~3,529            | **완료** |
| **3-1:** `ON CONFLICT` (해시 유니크 인덱스)            | 28,000              | ~3,571            | **완료** |
| **4-1:** `Staging Table` + `MERGE`                     | 30,000              | ~3,333            | **완료** |

## 3. 결론 및 분석

### **압도적인 성능 차이: 인덱스의 중요성**

- **인덱스 없는 SELECT (시나리오 1-1)**는 초당 약 32건을 처리하는 데 그쳐, **52분**이라는 매우 긴 시간이 소요되었습니다.
- 반면, **단순히 복합 인덱스 하나를 추가한 (시나리오 1-2)** 것만으로 성능은 **10배 이상 향상**되어 약 5분 만에 작업을 완료했습니다.
- 이는 대용량 데이터 처리에서 **인덱스가 필수적**임을 명확하게 보여주는 결과입니다.

### **최고의 전략: 데이터베이스 기능 활용**

- 데이터베이스의 내장 기능(`ON CONFLICT`, `MERGE`)을 활용한 시나리오들(2-1, 3-1, 4-1)은 애플리케이션 레벨에서 처리하는 방식(1-1, 1-2)을 압도하는 성능을 보여주었습니다.
- 특히 가장 효율적인 **해시 인덱스 기반 `ON CONFLICT` (시나리오 3-1)**는 가장 비효율적인 시나리오 1-1에 비해 **약 111배**, 인덱스가 있는 시나리오 1-2에 비해서도 **약 10배** 빠른 결과를 기록했습니다.
- 이는 불필요한 네트워크 통신을 최소화하고, 데이터베이스가 내부적으로 최적화된 로직을 수행하는 것이 얼마나 중요한지를 증명합니다.

### **어떤 전략을 선택할 것인가?**

- **`ON CONFLICT` (시나리오 2-1, 3-1):** 가장 빠르고 간결한 방법입니다. 데이터 구조가 비교적 단순하고, 비즈니스 키가 변경될 가능성이 적을 때 이상적입니다. 특히 복합 키가 길고 복잡하다면 **해시 인덱스(3-1)**를 사용하는 것이 인덱스 크기와 관리 측면에서 더 유리할 수 있습니다.

- **`Staging Table` (시나리오 4-1):** `ON CONFLICT`와 거의 대등한 성능을 보여주면서도 더 높은 유연성을 제공합니다. 단순히 중복을 무시하는 것뿐만 아니라, **데이터를 업데이트하거나, 로깅, 검증 등 복잡한 로직을 머지(Merge) 과정에 추가**할 수 있습니다. 대규모 ETL 파이프라인이나 복잡한 비즈니스 규칙이 필요한 데이터 적재 작업에 매우 적합한 전략입니다.

## 4. 최종 제언

특별한 경우가 아니라면, **애플리케이션 레벨에서 건건이 `SELECT`하여 중복을 확인하는 방식(시나리오 1-1, 1-2)은 반드시 피해야 합니다.**

대신, 데이터베이스가 제공하는 **`ON CONFLICT`나 `Staging Table`을 활용한 `MERGE` 전략을 적극적으로 채택**하는 것이 바람직합니다. 두 전략 모두 뛰어난 성능을 제공하므로, 구현의 단순성과 비즈니스 로직의 복잡성을 고려하여 적절한 방안을 선택하는 것이 좋습니다.